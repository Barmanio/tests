{% extends "base.html" %}

{% block title %}‚ûï –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–¥–∞—á–∏ ‚Äî –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–±—É—á–µ–Ω–∏—è{% endblock %}

{% block content %}
<h1>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h1>

<!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ -->
{% if error %}
<div class="alert alert-error">
    <strong>‚ùå –û—à–∏–±–∫–∞:</strong> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ:</strong> {{ success }}
</div>
{% endif %}

<form id="taskForm" method="post" action="/data-entry">
    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ -->
    <div class="form-group">
        <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
        <input
                type="text"
                id="title"
                name="title"
                required
                maxlength="100"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—É–º–º–∞ –¥–≤—É—Ö —á–∏—Å–µ–ª"
                style="width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; transition: border 0.3s; font-family: inherit;">
    </div>

    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
    <div class="form-group">
        <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea
                id="description"
                name="description"
                required
                maxlength="1000"
                placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–≤–∞ —á–∏—Å–ª–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö —Å—É–º–º—É."
                style="width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 100px; transition: border 0.3s; font-family: inherit;"></textarea>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ—Å—Ç–æ–≤ -->
    <h2>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã</h2>
    <div id="tests-container">
        <!-- –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
    </div>

    <button
            type="button"
            class="btn"
            style="background: #3498db; color: white; margin-bottom: 20px;"
            onclick="addTest()">
        + –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
    </button>

    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
</form>

<!-- –°—Å—ã–ª–∫–∏ –Ω–∞–∑–∞–¥ -->
<a href="/home" class="back-link"
   style="display: block; text-align: center; margin: 25px 0 0; color: #2a8d9c; text-decoration: none; font-size: 0.95em;">‚Üê
    –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
<a href="/home" class="back-link"
   style="display: block; text-align: center; margin: 5px 0 0; color: #2a8d9c; text-decoration: none; font-size: 0.95em;">–∏–ª–∏
    –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</a>

<!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ -->
<div style="text-align: center; margin-top: 15px;">
    <button type="button" onclick="clearDraft()"
            style="color: #7f8c8d; background: none; border: none; font-size: 0.9em; cursor: pointer; text-decoration: underline;">
        –û—á–∏—Å—Ç–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
    </button>
</div>

<script>
    const formId = 'task-draft';
    let testCount = 0;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    window.addEventListener('load', () => {
    loadDraft();
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    ['title', 'description'].forEach(id => {
    document.getElementById(id).addEventListener('input', saveDraft);
    });
    document.getElementById('tests-container').addEventListener('input', saveDraft);

    function saveDraft() {
    const draft = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    tests: []
    };

    document.querySelectorAll('.test-group').forEach(group => {
    const inputs = group.querySelectorAll('textarea');
    const inputVal = inputs0.value.trim();
    const expectedVal = inputs1.value.trim();
    if (inputVal || expectedVal) {
    draft.tests.push({
    input: inputVal,
    expected_output: expectedVal
    });
    }
    });

    try {
    localStorage.setItem(formId, JSON.stringify(draft));
    console.log('‚úÖ –ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    } catch (e) {
    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage', e);
    }
    }

    function loadDraft() {
    const saved = localStorage.getItem(formId);
    if (!saved) {
    addTest(); // –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç
    return;
    }

    try {
    const draft = JSON.parse(saved);
    document.getElementById('title').value = draft.title || '';
    document.getElementById('description').value = draft.description || '';

    if (draft.tests && draft.tests.length > 0) {
    draft.tests.forEach(t => addTest(t.input, t.expected_output));
    } else {
    addTest();
    }
    console.log('üîÅ –ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω');
    } catch (e) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–∞', e);
    addTest();
    }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    function addTest(inputValue = '', expectedValue = '') {
    const container = document.getElementById('tests-container');
    const index = testCount++;

    const testGroup = document.createElement('div');
    testGroup.className = 'test-group';
    testGroup.dataset.index = index;
    testGroup.style = 'background: #f8f9fa; padding: 20px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 15px; position: relative;';

    testGroup.innerHTML = `
    <h3 style="margin-top: 0; color: #1b6aaa; font-size: 1.1em;">–¢–µ—Å—Ç ${index + 1}</h3>
    <button type="button" class="test-remove" onclick="removeTest(this)" style="position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: background 0.3s;">√ó</button>

    <div class="form-group">
    <label>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ)</label>
    <textarea
    name="input"
    required
    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:
   5
   1 2 3 4 5"
    style="width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 80px; font-family: 'Courier New', monospace; line-height: 1.4;">${inputValue}</textarea>
    </div>

    <div class="form-group">
    <label>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–æ–∂–Ω–æ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ)</label>
    <textarea
    name="expected_output"
    required
    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:
   15"
    style="width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 80px; font-family: 'Courier New', monospace; line-height: 1.4;">${expectedValue}</textarea>
    </div>
    `;
    container.appendChild(testGroup);
    saveDraft();
    }

    function removeTest(button) {
    const testGroup = button.closest('.test-group');
    if (document.querySelectorAll('.test-group').length > 1) {
    testGroup.remove();
    saveDraft();
    } else {
    alert('–ù—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç.');
    }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.getElementById('taskForm').onsubmit = function(e) {
    const inputs = document.querySelectorAll('textareaname="input"');
    const filled = Array.from(inputs).some(ta => ta.value.trim() !== '');

    if (!filled) {
    e.preventDefault();
    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç —Å –¥–∞–Ω–Ω—ã–º–∏.');
    }

    // –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    setTimeout(() => {
    try {
    localStorage.removeItem(formId);
    console.log('üóëÔ∏è –ß–µ—Ä–Ω–æ–≤–∏–∫ —É–¥–∞–ª—ë–Ω –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    } catch (e) {
    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫', e);
    }
    }, 100);
    };

    // –û—á–∏—Å—Ç–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
    window.clearDraft = function() {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?')) {
    localStorage.removeItem(formId);
    location.reload();
    }
    };
</script>
{% endblock %}
